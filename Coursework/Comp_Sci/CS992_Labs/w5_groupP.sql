/* ----- */
/* Lab 4 */
/* ----- */

/* --- SUBMISSION 5 (a) --- */

/* Above altered to display largest to smallest population rank */

 SELECT country, "2012",
    RANK() OVER(ORDER BY "2012" DESC) AS population_rank_2012
    FROM world.world_population
    ORDER BY country;

/* --- SUBMISSION 5 (b) --- */

/* Top 20 countries of population in 2012
 Had not been in this grouping pre 1962 */

CREATE OR REPLACE VIEW top_20 AS
    SELECT country, "1962", "2012",
        RANK() OVER(ORDER BY "1962" DESC) AS pop_rank_1962,
        RANK() OVER(ORDER BY "2012" DESC) AS pop_rank_2012
        FROM world.world_population
        WHERE "2012" IS NOT NULL
        AND "1962" IS NOT NULL;

SELECT * FROM top_20
    WHERE pop_rank_2012 <= 20
    AND pop_rank_1962 > 20
    ORDER BY pop_rank_2012;

/* --- SUBMISSION 5 (c) --- */

/* 5 smallest countries in the world using LAG */

SELECT pop_order, country, pop_2012,
   DECODE(pop_order, 1, NULL, larger_than) AS larger_than_next_smallest
   FROM (
        SELECT RANK() OVER(ORDER BY "2012" ASC) AS pop_order,
            country,
            TO_CHAR("2012", '999G999G999G990') pop_2012,
            TO_CHAR("2012" - LAG("2012", 1, 0) OVER(ORDER BY "2012"), 
                '999G999G999G999G999G990') larger_than
            FROM world.world_population
            WHERE "2012" IS NOT NULL
            ORDER BY pop_order
    ) x
    WHERE pop_order <= 5;

/* --- SUBMISSION 5 (d) --- */

/* The following `code' was written by group P */

/* Top 10 population changers and how average growth has differed
 on a time-series basis, also displayed against linear population change
 change increments over the last 10 years. */

/* Would have preferred to have done this over 50 years but there's
 a lot of null values after 10 years */

SELECT rank_aag,
    country,
    aag,
    DECODE(rank_aag, 0, NULL, lag1_aag) AS Δaag_lag1,
    DECODE(rank_aag, 0, NULL, lag2_aag) AS Δaag_lag2,
    DECODE(rank_aag, 0, NULL, lag3_aag) AS Δaag_lag3,
    DECODE(rank_aag, 0, NULL, lag4_aag) AS Δaag_lag4,
    DECODE(rank_aag, 0, NULL, lag5_aag) AS Δaag_lag5,
    "Latest Population (2012)",
    "Δ1yr", "Δ1yr (%)", "Δ5yr", "Δ5yr (%)", "Δ10yr", "Δ10yr (%)"
    FROM (
        SELECT
            /* Rank countries by average annual growth (AAG) rate */
            RANK() OVER(
                ORDER BY (
                    (
                        ((("2012" - "2011") / "2011") * 100) +
                        ((("2011" - "2010") / "2010") * 100) +
                        ((("2010" - "2009") / "2009") * 100) + 
                        ((("2009" - "2008") / "2008") * 100) +
                        ((("2008" - "2007") / "2007") * 100) +
                        ((("2007" - "2006") / "2006") * 100) +
                        ((("2006" - "2005") / "2005") * 100) +
                        ((("2005" - "2004") / "2004") * 100) +
                        ((("2004" - "2003") / "2003") * 100) +
                        ((("2003" - "2002") / "2002") * 100)
                    ) / 10
                ) DESC
            ) AS rank_aag,
            country,
            /* Calculating average annual growth - to output */
            TO_CHAR(
                (
                    ((("2012" - "2011") / "2011") * 100) +
                    ((("2011" - "2010") / "2010") * 100) +
                    ((("2010" - "2009") / "2009") * 100) + 
                    ((("2009" - "2008") / "2008") * 100) +
                    ((("2008" - "2007") / "2007") * 100) +
                    ((("2007" - "2006") / "2006") * 100) +
                    ((("2006" - "2005") / "2005") * 100) +
                    ((("2005" - "2004") / "2004") * 100) +
                    ((("2004" - "2003") / "2003") * 100) +
                    ((("2003" - "2002") / "2002") * 100)
                ) / 10, '999G999D00'
            ) aag,
            /* Observing Δ in average annual growth with one lag from 2012--2002 */
            TO_CHAR(
                (
                    ((("2012" - "2011") / "2011") * 100) +
                    ((("2011" - "2010") / "2010") * 100) +
                    ((("2010" - "2009") / "2009") * 100) + 
                    ((("2009" - "2008") / "2008") * 100) +
                    ((("2008" - "2007") / "2007") * 100) +
                    ((("2007" - "2006") / "2006") * 100) +
                    ((("2006" - "2005") / "2005") * 100) +
                    ((("2005" - "2004") / "2004") * 100) +
                    ((("2004" - "2003") / "2003") * 100) +
                    ((("2003" - "2002") / "2002") * 100)
                ) / 10
                -
                LAG((
                    ((("2012" - "2011") / "2011") * 100) +
                    ((("2011" - "2010") / "2010") * 100) +
                    ((("2010" - "2009") / "2009") * 100) + 
                    ((("2009" - "2008") / "2008") * 100) +
                    ((("2008" - "2007") / "2007") * 100) +
                    ((("2007" - "2006") / "2006") * 100) +
                    ((("2006" - "2005") / "2005") * 100) +
                    ((("2005" - "2004") / "2004") * 100) +
                    ((("2004" - "2003") / "2003") * 100) +
                    ((("2003" - "2002") / "2002") * 100)
                ) / 10, 1, 0)
                OVER(ORDER BY 
                    (
                        ((("2012" - "2011") / "2011") * 100) +
                        ((("2011" - "2010") / "2010") * 100) +
                        ((("2010" - "2009") / "2009") * 100) + 
                        ((("2009" - "2008") / "2008") * 100) +
                        ((("2008" - "2007") / "2007") * 100) +
                        ((("2007" - "2006") / "2006") * 100) +
                        ((("2006" - "2005") / "2005") * 100) +
                        ((("2005" - "2004") / "2004") * 100) +
                        ((("2004" - "2003") / "2003") * 100) +
                        ((("2003" - "2002") / "2002") * 100)
                    ) / 10
                ), '999G999D00'
            ) lag1_aag,
            /* Observing Δ in average annual growth with two lags from 2012--2002 */
            TO_CHAR(
                (
                    ((("2012" - "2011") / "2011") * 100) +
                    ((("2011" - "2010") / "2010") * 100) +
                    ((("2010" - "2009") / "2009") * 100) + 
                    ((("2009" - "2008") / "2008") * 100) +
                    ((("2008" - "2007") / "2007") * 100) +
                    ((("2007" - "2006") / "2006") * 100) +
                    ((("2006" - "2005") / "2005") * 100) +
                    ((("2005" - "2004") / "2004") * 100) +
                    ((("2004" - "2003") / "2003") * 100) +
                    ((("2003" - "2002") / "2002") * 100)
                ) / 10
                -
                LAG((
                    ((("2012" - "2011") / "2011") * 100) +
                    ((("2011" - "2010") / "2010") * 100) +
                    ((("2010" - "2009") / "2009") * 100) + 
                    ((("2009" - "2008") / "2008") * 100) +
                    ((("2008" - "2007") / "2007") * 100) +
                    ((("2007" - "2006") / "2006") * 100) +
                    ((("2006" - "2005") / "2005") * 100) +
                    ((("2005" - "2004") / "2004") * 100) +
                    ((("2004" - "2003") / "2003") * 100) +
                    ((("2003" - "2002") / "2002") * 100)
                ) / 10, 2, 0)
                OVER(ORDER BY 
                    (
                        ((("2012" - "2011") / "2011") * 100) +
                        ((("2011" - "2010") / "2010") * 100) +
                        ((("2010" - "2009") / "2009") * 100) + 
                        ((("2009" - "2008") / "2008") * 100) +
                        ((("2008" - "2007") / "2007") * 100) +
                        ((("2007" - "2006") / "2006") * 100) +
                        ((("2006" - "2005") / "2005") * 100) +
                        ((("2005" - "2004") / "2004") * 100) +
                        ((("2004" - "2003") / "2003") * 100) +
                        ((("2003" - "2002") / "2002") * 100)
                    ) / 10
                ), '999G999D00'
            ) lag2_aag,
            /* Observing Δ in average annual growth with three lags from 2012--2002 */
            TO_CHAR(
                (
                    ((("2012" - "2011") / "2011") * 100) +
                    ((("2011" - "2010") / "2010") * 100) +
                    ((("2010" - "2009") / "2009") * 100) + 
                    ((("2009" - "2008") / "2008") * 100) +
                    ((("2008" - "2007") / "2007") * 100) +
                    ((("2007" - "2006") / "2006") * 100) +
                    ((("2006" - "2005") / "2005") * 100) +
                    ((("2005" - "2004") / "2004") * 100) +
                    ((("2004" - "2003") / "2003") * 100) +
                    ((("2003" - "2002") / "2002") * 100)
                ) / 10
                -
                LAG((
                    ((("2012" - "2011") / "2011") * 100) +
                    ((("2011" - "2010") / "2010") * 100) +
                    ((("2010" - "2009") / "2009") * 100) + 
                    ((("2009" - "2008") / "2008") * 100) +
                    ((("2008" - "2007") / "2007") * 100) +
                    ((("2007" - "2006") / "2006") * 100) +
                    ((("2006" - "2005") / "2005") * 100) +
                    ((("2005" - "2004") / "2004") * 100) +
                    ((("2004" - "2003") / "2003") * 100) +
                    ((("2003" - "2002") / "2002") * 100)
                ) / 10, 3, 0)
                OVER(ORDER BY 
                    (
                        ((("2012" - "2011") / "2011") * 100) +
                        ((("2011" - "2010") / "2010") * 100) +
                        ((("2010" - "2009") / "2009") * 100) + 
                        ((("2009" - "2008") / "2008") * 100) +
                        ((("2008" - "2007") / "2007") * 100) +
                        ((("2007" - "2006") / "2006") * 100) +
                        ((("2006" - "2005") / "2005") * 100) +
                        ((("2005" - "2004") / "2004") * 100) +
                        ((("2004" - "2003") / "2003") * 100) +
                        ((("2003" - "2002") / "2002") * 100)
                    ) / 10
                ), '999G999D00'
            ) lag3_aag,
            /* Observing Δ in average annual growth with four lags from 2012--2002 */
            TO_CHAR(
                (
                    ((("2012" - "2011") / "2011") * 100) +
                    ((("2011" - "2010") / "2010") * 100) +
                    ((("2010" - "2009") / "2009") * 100) + 
                    ((("2009" - "2008") / "2008") * 100) +
                    ((("2008" - "2007") / "2007") * 100) +
                    ((("2007" - "2006") / "2006") * 100) +
                    ((("2006" - "2005") / "2005") * 100) +
                    ((("2005" - "2004") / "2004") * 100) +
                    ((("2004" - "2003") / "2003") * 100) +
                    ((("2003" - "2002") / "2002") * 100)
                ) / 10
                -
                LAG((
                    ((("2012" - "2011") / "2011") * 100) +
                    ((("2011" - "2010") / "2010") * 100) +
                    ((("2010" - "2009") / "2009") * 100) + 
                    ((("2009" - "2008") / "2008") * 100) +
                    ((("2008" - "2007") / "2007") * 100) +
                    ((("2007" - "2006") / "2006") * 100) +
                    ((("2006" - "2005") / "2005") * 100) +
                    ((("2005" - "2004") / "2004") * 100) +
                    ((("2004" - "2003") / "2003") * 100) +
                    ((("2003" - "2002") / "2002") * 100)
                ) / 10, 4, 0)
                OVER(ORDER BY 
                    (
                        ((("2012" - "2011") / "2011") * 100) +
                        ((("2011" - "2010") / "2010") * 100) +
                        ((("2010" - "2009") / "2009") * 100) + 
                        ((("2009" - "2008") / "2008") * 100) +
                        ((("2008" - "2007") / "2007") * 100) +
                        ((("2007" - "2006") / "2006") * 100) +
                        ((("2006" - "2005") / "2005") * 100) +
                        ((("2005" - "2004") / "2004") * 100) +
                        ((("2004" - "2003") / "2003") * 100) +
                        ((("2003" - "2002") / "2002") * 100)
                    ) / 10
                ), '999G999D00'
            ) lag4_aag,
            /* Observing Δ in average annual growth with five lags from 2012--2002 */
            TO_CHAR(
                (
                    ((("2012" - "2011") / "2011") * 100) +
                    ((("2011" - "2010") / "2010") * 100) +
                    ((("2010" - "2009") / "2009") * 100) + 
                    ((("2009" - "2008") / "2008") * 100) +
                    ((("2008" - "2007") / "2007") * 100) +
                    ((("2007" - "2006") / "2006") * 100) +
                    ((("2006" - "2005") / "2005") * 100) +
                    ((("2005" - "2004") / "2004") * 100) +
                    ((("2004" - "2003") / "2003") * 100) +
                    ((("2003" - "2002") / "2002") * 100)
                ) / 10
                -
                LAG((
                    ((("2012" - "2011") / "2011") * 100) +
                    ((("2011" - "2010") / "2010") * 100) +
                    ((("2010" - "2009") / "2009") * 100) + 
                    ((("2009" - "2008") / "2008") * 100) +
                    ((("2008" - "2007") / "2007") * 100) +
                    ((("2007" - "2006") / "2006") * 100) +
                    ((("2006" - "2005") / "2005") * 100) +
                    ((("2005" - "2004") / "2004") * 100) +
                    ((("2004" - "2003") / "2003") * 100) +
                    ((("2003" - "2002") / "2002") * 100)
                ) / 10, 5, 0)
                OVER(ORDER BY 
                    (
                        ((("2012" - "2011") / "2011") * 100) +
                        ((("2011" - "2010") / "2010") * 100) +
                        ((("2010" - "2009") / "2009") * 100) + 
                        ((("2009" - "2008") / "2008") * 100) +
                        ((("2008" - "2007") / "2007") * 100) +
                        ((("2007" - "2006") / "2006") * 100) +
                        ((("2006" - "2005") / "2005") * 100) +
                        ((("2005" - "2004") / "2004") * 100) +
                        ((("2004" - "2003") / "2003") * 100) +
                        ((("2003" - "2002") / "2002") * 100)
                    ) / 10
                ), '999G999D00'
            ) lag5_aag,
            TO_CHAR("2012",'999G999G999G999G999G990') "Latest Population (2012)",  
            TO_CHAR("2012" - "2011", '999G999G999G990') "Δ1yr",  
            TO_CHAR((("2012" - "2011") / "2011") * 100, '999G999D00') "Δ1yr (%)",  
            TO_CHAR("2012" - "2007", '999G999G999G990') "Δ5yr", 
            TO_CHAR((("2012" - "2007") / "2007") * 100, '999G999D00') "Δ5yr (%)", 
            TO_CHAR("2012" - "2002", '999G999G999G990') "Δ10yr",  
            TO_CHAR((("2012" - "2002") / "2002") * 100, '999G999D00') "Δ10yr (%)"
            FROM world.world_population
            WHERE "2012" IS NOT NULL
            ORDER BY rank_aag
    )
    WHERE rownum <= 10;

/* As observed in the results table, Qatar holds the largest average annual
 rate across the ten year period of 2002--2012. It also majorly dominates in
 AAG change across the five lagged periods however, experiences a slowing in
 the rate of increase. On a more basic level, it also dominates across the linear
 5 year and 10 year changes with the largest percentage increases however, again
 is observed to slow at the 1 year change mark, in comparison to other countries.
 Its population is a lot smaller than those of other countries however, and is 
 subject to periodic spikes which may account for some of the high variance. */
